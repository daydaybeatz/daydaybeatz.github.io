<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Interactive Fiction</title>

<style>
body{margin:0;background:#111;color:#eee;font-family:system-ui, monospace}
#app{max-width:720px;margin:0 auto;padding:12px}
.panel{background:#222;border:1px solid #444;padding:10px;margin-bottom:10px;border-radius:6px}
#text{white-space:pre-wrap;font-size:16px}
button{
  width:100%;min-height:48px;
  background:#333;color:#fff;
  border:1px solid #555;border-radius:6px;
  padding:10px;text-align:left
}
#error{color:#f88;white-space:pre-wrap}
</style>
</head>

<body>
<div id="app">
  <div id="error" class="panel" style="display:none"></div>
  <div id="stats" class="panel"></div>
  <div id="text" class="panel"></div>
  <div id="options"></div>
</div>

<script>
let story={pages:{}};
let state={page:null,stats:{},flags:{},quests:{}};
const errorBox=document.getElementById("error");

fetch("story.txt")
.then(r=>{
  if(!r.ok) throw new Error("Failed to load story.txt");
  return r.text();
})
.then(parse)
.then(start)
.catch(showError);

function showError(e){
  errorBox.style.display="block";
  errorBox.textContent="ERROR:\n"+e.message;
  console.error(e);
}

function parse(txt){
  let lines=txt.split("\n");
  let mode=null,page=null,opt=null;
  let inEnter=false;

  for(let raw of lines){
    let line=raw.trim();
    if(!line) continue;

    if(line.startsWith("@")){
      let p=line.slice(1).split(" ");
      mode=p[0];
      page=null; opt=null; inEnter=false;

      if(mode==="room"||mode==="npc"){
        story.pages[p[1]]={text:"",opts:[],enter:[]};
        page=story.pages[p[1]];
      }
      continue;
    }

    if(mode==="stats"){
      let[k,v]=line.split(":"); state.stats[k]=+v; continue;
    }

    if(mode==="flags"){
      let[k,v]=line.split(":");
      state.flags[k]=(v==="true"); continue;
    }

    if(mode==="quests"){
      state.quests[line]={state:"inactive",step:""}; continue;
    }

    if(page){
      if(line==="!enter"){ inEnter=true; continue; }

      if(line.startsWith("-")){
        inEnter=false;
        opt={label:line.slice(1).trim(),acts:[],chance:null};
        page.opts.push(opt);
        continue;
      }

      if(line==="!chance"){
        if(!opt) throw new Error("!chance without option");
        opt.chance=[];
        continue;
      }

      if(line.startsWith("*")){
        let a=line.slice(1).trim();
        if(inEnter){
          page.enter.push(a);
          continue;
        }
        if(!opt) throw new Error("Action (*) without option");
        (opt.chance||opt.acts).push(a);
        continue;
      }

      page.text+=line+"\n";
    }
  }

  if(!Object.keys(story.pages).length){
    throw new Error("No rooms defined");
  }
}

function start(){
  state.page=Object.keys(story.pages)[0];
  runEnter();
  render();
}

function runEnter(){
  story.pages[state.page].enter.forEach(runAction);
}

function render(){
  stats.textContent=
    Object.entries(state.stats).map(e=>e.join(":")).join(" | ");
  text.textContent=story.pages[state.page].text;
  options.innerHTML="";
  story.pages[state.page].opts.forEach(o=>{
    let b=document.createElement("button");
    b.textContent=o.label;
    b.onclick=()=>choose(o);
    options.appendChild(b);
  });
}

function choose(o){
  let acts=o.chance
    ? [o.chance[Math.floor(Math.random()*o.chance.length)]]
    : o.acts;
  acts.forEach(runAction);
  render();
}

function runAction(a){
  if(a.startsWith("room(")) state.page=a.slice(5,-1);
  else if(a.startsWith("result(")) alert(a.slice(7,-1));
}
</script>
</body>
</html>
