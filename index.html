<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IF Engine v2.0</title>

<style>
:root{
  --bg:#0f0f0f;
  --panel:#1b1b1b;
  --border:#333;
  --text:#eee;
  --accent:#7fff9f;
  --bad:#ff6b6b;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui, monospace;
}
#app{max-width:820px;margin:auto;padding:12px}
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
}
button{
  width:100%;
  min-height:44px;
  background:#222;
  color:#fff;
  border:1px solid #444;
  border-radius:6px;
  padding:10px;
  text-align:left;
}
button:hover{background:#2a2a2a}
#options{display:flex;flex-direction:column;gap:8px}
#inv,#stash{display:flex;flex-wrap:wrap;gap:6px}
.item{
  padding:6px 10px;
  background:#2a2a2a;
  border-radius:6px;
  font-size:13px;
}
.item.equipped{outline:2px solid var(--accent)}
.small{opacity:.7;font-size:13px}
#log{font-size:13px;white-space:pre-wrap}
</style>
</head>

<body>
<div id="app">

<div id="loader" class="panel">
  <div>Select Game</div>
  <div id="gameList"></div>
</div>

<div id="game" style="display:none">

  <div id="stats" class="panel small"></div>

  <div class="panel">
    <b>Equipment</b>
    <div id="equip" class="small"></div>
  </div>

  <div class="panel">
    <b>Inventory</b>
    <div id="inv"></div>
  </div>

  <div class="panel">
    <b>Stash</b>
    <div id="stash"></div>
  </div>

  <div id="text" class="panel"></div>
  <div id="options"></div>

  <div class="panel">
    <b>Log</b>
    <div id="log"></div>
  </div>

</div>
</div>

<script>
/* ================= ENGINE CORE ================= */

let GAME = {
  rules:{
    clampStats:true,
    enableTime:true,
    maxDays:7,
    excursionsPerDay:2,
    radiationEnabled:true,
    radiationThreshold:6,
    radiationDamage:2
  }
};

let story={rooms:{}};

let state={
  room:null,
  stats:{},
  inventory:[],
  stash:[],
  equipment:{weapon:null,armor:null,cloak:null},
  attempts:{},
  excursions:0,
  log:[]
};

/* ================= UTILS ================= */

function log(msg){
  state.log.unshift(msg);
  if(state.log.length>8) state.log.pop();
}

function clamp(){
  if(!GAME.rules.clampStats) return;
  for(let k in state.stats){
    if(typeof state.stats[k]==="number"){
      state.stats[k]=Math.max(0,state.stats[k]);
    }
  }
}

function renderText(txt){
  return txt.replace(/\{(\w+)\}/g,(_,k)=>state.stats[k]??"");
}

/* ================= GAME LOADER ================= */

fetch("games.json").then(r=>r.json()).then(list=>{
  let gl=document.getElementById("gameList");
  list.forEach(g=>{
    let b=document.createElement("button");
    b.textContent=g.title;
    b.onclick=()=>loadGame(g.file);
    gl.appendChild(b);
  });
});

function loadGame(file){
  fetch(file).then(r=>r.text()).then(parse).then(start);
}

/* ================= PARSER ================= */

function parse(txt){
  story={rooms:{}};
  state.inventory=[];
  state.stash=[];
  state.equipment={weapon:null,armor:null,cloak:null};
  state.stats={};
  state.attempts={};
  state.excursions=0;
  state.log=[];

  let room=null,opt=null;

  txt.split("\n").forEach(raw=>{
    let l=raw.trim();
    if(!l) return;

    if(l.startsWith("@stats")) return;

    if(!room && l.includes(":")){
      let[k,v]=l.split(":");
      state.stats[k]=+v;
      return;
    }

    if(l.startsWith("@room")){
      let id=l.split(" ")[1];
      story.rooms[id]={text:"",options:[]};
      room=story.rooms[id];
      return;
    }

    if(room){
      if(l.startsWith("-")){
        let m=l.match(/\(attempts:(\d+)\)/);
        opt={label:l.replace(/\(.+\)/,"").slice(1).trim(),acts:[],max:m?+m[1]:null};
        room.options.push(opt);
        return;
      }
      if(l.startsWith("*")){
        opt.acts.push(l.slice(1).trim());
        return;
      }
      room.text+=l+"\n";
    }
  });
}

/* ================= START ================= */

function start(){
  document.getElementById("loader").style.display="none";
  document.getElementById("game").style.display="block";
  state.room=Object.keys(story.rooms)[0];
  render();
}

/* ================= RENDER ================= */

function render(){
  clamp();

  // radiation damage
  if(GAME.rules.radiationEnabled && state.stats.rad>=GAME.rules.radiationThreshold){
    state.stats.health-=GAME.rules.radiationDamage;
    log("Radiation burns your body.");
    if(state.stats.health<=0){
      state.room="death";
    }
  }

  let r=story.rooms[state.room];

  stats.textContent=Object.entries(state.stats).map(e=>e.join(":")).join(" | ");

  equip.textContent=
    `Weapon: ${state.equipment.weapon||"-"} | `+
    `Armor: ${state.equipment.armor||"-"} | `+
    `Cloak: ${state.equipment.cloak||"-"}`;

  inv.innerHTML="";
  state.inventory.forEach(i=>{
    let d=document.createElement("div");
    d.className="item";
    d.textContent=i;
    d.onclick=()=>useItem(i);
    inv.appendChild(d);
  });

  stash.innerHTML="";
  state.stash.forEach(i=>{
    let d=document.createElement("div");
    d.className="item";
    d.textContent=i;
    stash.appendChild(d);
  });

  text.textContent=renderText(r.text);

  options.innerHTML="";
  r.options.forEach(o=>{
    let key=state.room+"|"+o.label;
    state.attempts[key]??=o.max;

    if(o.max!==null && state.attempts[key]<=0) return;

    let b=document.createElement("button");
    b.textContent=o.label;
    b.onclick=()=>{
      if(o.max!==null) state.attempts[key]--;
      o.acts.forEach(run);
      render();
    };
    options.appendChild(b);
  });

  logDiv.innerHTML=state.log.join("\n");
}

/* ================= ACTIONS ================= */

function run(a){
  let p=a.split(" ");
  if(p[0]==="goto"){
    state.room=p[1];
    return;
  }
  if(p[0]==="stat"){
    state.stats[p[1]]+=+p[2];
    return;
  }
  if(p[0]==="give"){
    state.inventory.push(p[1]);
    log(`Found ${p[1]}.`);
    return;
  }
  if(p[0]==="stash"){
    state.stash.push(p[1]);
    log(`Stored ${p[1]}.`);
    return;
  }
  if(p[0]==="equip"){
    let type=p[1];
    let item=p[2];
    state.equipment[type]=item;
    log(`Equipped ${item}.`);
    return;
  }
}

/* ================= INVENTORY ================= */

function useItem(it){
  if(it.startsWith("weapon_")){
    state.equipment.weapon=it;
    log(`Weapon equipped: ${it}`);
  }
  else if(it.startsWith("armor_")){
    state.equipment.armor=it;
    log(`Armor equipped: ${it}`);
  }
  else if(it.startsWith("cloak_")){
    state.equipment.cloak=it;
    log(`Cloak equipped: ${it}`);
  }
  else if(it==="medkit"){
    state.stats.health+=20;
    state.inventory.splice(state.inventory.indexOf(it),1);
    log("Used medkit.");
  }
  render();
}
</script>
</body>
</html>
