<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Interactive Fiction</title>

<style>
:root{
  --bg:#111; --fg:#eee; --ui:#222; --border:#444; --accent:#9f9;
}
html,body{
  margin:0; padding:0; height:100%;
  background:var(--bg); color:var(--fg);
  font-family:system-ui, -apple-system, monospace;
}
#app{ max-width:720px; margin:0 auto; padding:14px; }
.panel{
  border:1px solid var(--border);
  background:var(--ui);
  padding:10px; margin-bottom:12px; border-radius:6px;
}
#stats{ color:var(--accent); font-size:14px; }
#quests{ color:#ccc; font-size:14px; }
#text{ white-space:pre-wrap; font-size:16px; line-height:1.5; }
button{
  width:100%; min-height:48px;
  background:#333; color:#fff;
  border:1px solid var(--border);
  border-radius:6px; padding:10px;
  font-size:16px; text-align:left;
}
#error{ color:#f88; white-space:pre-wrap; }
</style>
</head>

<body>
<div id="app">
  <div id="error" class="panel" style="display:none"></div>
  <div id="stats" class="panel"></div>
  <div id="quests" class="panel"></div>
  <div id="text" class="panel"></div>
  <div id="options"></div>
</div>

<script>
let story={pages:{}};
let state={ page:null, stats:{}, inv:[], flags:{}, quests:{} };

const errorBox=document.getElementById("error");

fetch("story.txt")
.then(r=>{
  if(!r.ok) throw new Error("Failed to load story.txt ("+r.status+")");
  return r.text();
})
.then(parseStory)
.then(startGame)
.catch(showError);

function showError(e){
  errorBox.style.display="block";
  errorBox.textContent="ERROR:\n"+e.message;
  console.error(e);
}

function parseStory(txt){
  let lines=txt.split("\n");
  let mode=null, page=null, opt=null;

  for(let raw of lines){
    let line=raw.trim();
    if(!line) continue;

    if(line.startsWith("@")){
      let p=line.slice(1).split(" ");
      mode=p[0];
      page=null;
      opt=null;

      if(mode==="room"||mode==="npc"){
        story.pages[p[1]]={text:"",opts:[]};
        page=story.pages[p[1]];
      }
      continue;
    }

    if(mode==="stats"){
      let [k,v]=line.split(":");
      state.stats[k]=+v;
      continue;
    }

    if(mode==="inventory"){ state.inv.push(line); continue; }

    if(mode==="flags"){
      let [k,v]=line.split(":");
      state.flags[k]=(v==="true")?true:(+v||false);
      continue;
    }

    if(mode==="quests"){
      state.quests[line]={state:"inactive",step:"",stats:{}};
      continue;
    }

    if(page){
      if(line.startsWith("-")){
        opt={label:line.slice(1).trim(),acts:[],chance:null};
        page.opts.push(opt);
        continue;
      }

      if(line==="!chance"){
        if(!opt){
          throw new Error("!chance used without a preceding option (-)");
        }
        opt.chance=[];
        continue;
      }

      if(line.startsWith("*")){
        if(!opt){
          throw new Error("Action (*) used without a preceding option (-)");
        }
        (opt.chance||opt.acts).push(line.slice(1).trim());
        continue;
      }

      page.text+=line+"\n";
    }
  }

  if(Object.keys(story.pages).length===0){
    throw new Error("No @room sections found in story.txt");
  }
}

function startGame(){
  state.page=Object.keys(story.pages)[0];
  render();
}

function render(){
  stats.textContent=
    Object.entries(state.stats).map(e=>e.join(":")).join(" | ") || "No stats";

  quests.textContent=
    Object.entries(state.quests)
      .filter(q=>q[1].state==="active")
      .map(q=>q[0]+": "+q[1].step)
      .join("\n") || "No active quests";

  let p=story.pages[state.page];
  text.textContent=p.text;

  options.innerHTML="";
  p.opts.forEach(o=>{
    let b=document.createElement("button");
    b.textContent=o.label;
    b.onclick=()=>runOption(o);
    options.appendChild(b);
  });
}

function runOption(o){
  let acts=o.chance
    ? [o.chance[Math.floor(Math.random()*o.chance.length)]]
    : o.acts;

  acts.forEach(runAction);
  render();
}

function runAction(a){
  if(a.startsWith("room(")) state.page=a.slice(5,-1);
  else if(a.startsWith("set(")){
    let [k,v]=a.slice(4,-1).split(",");
    state.stats[k]+=Number(v);
  }
  else if(a.startsWith("say(")) alert(a.slice(4,-1));
  else if(a==="win") alert("YOU WIN");
}
</script>

</body>
</html>
