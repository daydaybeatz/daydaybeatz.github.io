<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>IF Engine</title>

<style>
body{margin:0;background:#111;color:#eee;font-family:system-ui,monospace}
#app{max-width:720px;margin:auto;padding:12px}
.panel{background:#222;border:1px solid #444;padding:10px;margin-bottom:10px;border-radius:6px}
button{width:100%;min-height:48px;background:#333;color:#fff;border:1px solid #555;border-radius:6px;padding:10px;text-align:left}
#options{display:flex;flex-direction:column;gap:8px}
#inventory{display:flex;gap:8px;flex-wrap:wrap}
.item{background:#333;padding:6px 10px;border-radius:6px}
.small{opacity:.7;font-size:13px}
</style>
</head>

<body>
<div id="app">

  <div id="loader" class="panel">
    <div>Select a game:</div>
    <div id="gameList"></div>
  </div>

  <div id="game" style="display:none">
    <div id="stats" class="panel"></div>
    <div id="quests" class="panel small"></div>
    <div id="text" class="panel"></div>
    <div id="options"></div>
    <div id="inventory" class="panel"></div>
  </div>

</div>

<script>
let story={rooms:{}}
let state={
  room:null,
  stats:{},
  inventory:[],
  quests:{},
  attempts:{}
}

/* ---------- LOAD GAME LIST ---------- */
fetch("games.json")
.then(r=>r.json())
.then(showGames)
.catch(()=>alert("games.json missing"))

function showGames(list){
  let gl=document.getElementById("gameList")
  gl.innerHTML=""
  list.forEach(g=>{
    let b=document.createElement("button")
    b.innerText=g.title
    b.onclick=()=>loadGame(g.file)
    gl.appendChild(b)
  })
}

/* ---------- LOAD GAME ---------- */
function loadGame(file){
  fetch(file)
  .then(r=>{
    if(!r.ok) throw "Failed to load "+file
    return r.text()
  })
  .then(parse)
  .then(start)
  .catch(e=>alert(e))
}

/* ---------- PARSER ---------- */
function parse(txt){
  story={rooms:{}}
  state.stats={}
  state.inventory=[]
  state.quests={}
  state.attempts={}

  let lines=txt.split("\n")
  let room=null,opt=null

  for(let raw of lines){
    let l=raw.trim()
    if(!l) continue

    if(l.startsWith("@room")){
      let id=l.split(" ")[1]
      story.rooms[id]={text:"",options:[]}
      room=story.rooms[id]
      continue
    }

    if(l.startsWith("@stats")) continue

    if(l.includes(":") && !room){
      let [k,v]=l.split(":")
      state.stats[k]=+v
      continue
    }

    if(l.startsWith("@quest")){
      let id=l.split(" ")[1]
      state.quests[id]="active"
      continue
    }

    if(room){
      if(l.startsWith("-")){
        let m=l.match(/\(attempts:(\d+)(,hide)?\)/)
        opt={
          label:l.replace(/\(.+\)/,"").slice(1).trim(),
          actions:[],
          max:m?+m[1]:null,
          hide:m?.[2]
        }
        room.options.push(opt)
        continue
      }

      if(l.startsWith("*")){
        opt.actions.push(l.slice(1).trim())
        continue
      }

      room.text+=l+"\n"
    }
  }
}

/* ---------- START ---------- */
function start(){
  document.getElementById("loader").style.display="none"
  document.getElementById("game").style.display="block"
  state.room=Object.keys(story.rooms)[0]
  render()
}

/* ---------- RENDER ---------- */
function render(){
  let r=story.rooms[state.room]

  stats.innerText=Object.entries(state.stats).map(e=>e.join(":")).join(" | ")
  quests.innerText="Quests:\n"+Object.keys(state.quests).join("\n")
  text.innerText=r.text

  options.innerHTML=""
  r.options.forEach(o=>{
    let key=state.room+"|"+o.label
    state.attempts[key]??=o.max

    if(o.max!==null && state.attempts[key]<=0) return

    let label=o.label
    if(o.max!==null && !o.hide){
      label+=` (${state.attempts[key]}/${o.max})`
    }

    let b=document.createElement("button")
    b.innerText=label
    b.onclick=()=>{
      if(o.max!==null) state.attempts[key]--
      o.actions.forEach(run)
      render()
    }
    options.appendChild(b)
  })

  inventory.innerHTML="Inventory:"
  state.inventory.forEach(i=>{
    let d=document.createElement("div")
    d.className="item"
    d.innerText=i
    inventory.appendChild(d)
  })
}

/* ---------- ACTIONS ---------- */
function run(a){
  if(a.startsWith("goto")){
    state.room=a.split(" ")[1]
  }
  if(a.startsWith("give")){
    state.inventory.push(a.split(" ")[1])
  }
  if(a.startsWith("stat")){
    let [_,k,v]=a.split(" ")
    state.stats[k]+=+v
  }
}
</script>
</body>
</html>
